<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#008080">
    <title>PersonalOS</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#008080',
                    }
                }
            }
        }
    </script>
    <style>
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen p-4">
    
    <!-- Grid Container -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-6xl mx-auto">
        
        <!-- Time Widget -->
        <div class="bg-[#1a1a1a] border border-[#2a2a2a] rounded-lg p-6 flex flex-col items-center justify-center min-h-[200px]">
            <div id="time" class="text-6xl font-bold text-primary mb-2">12:34</div>
            <div id="date" class="text-gray-400">Friday, December 27</div>
        </div>
        
        <!-- Calendar Widget -->
        <div class="bg-[#1a1a1a] border border-[#2a2a2a] rounded-lg p-6 min-h-[200px]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Calendar</h2>
                <div class="flex gap-2">
                    <button onclick="app.addEvent()" class="text-primary hover:text-primary/80 text-2xl">+</button>
                    <button onclick="app.goToToday()" class="text-primary hover:text-primary/80">Today</button>
                </div>
            </div>
            <div id="calendar" class="grid grid-cols-7 gap-2 text-center text-sm">
                <!-- Calendar will be generated here -->
            </div>
        </div>
        
        <!-- Events Widget -->
        <div class="bg-[#1a1a1a] border border-[#2a2a2a] rounded-lg p-6 min-h-[200px] md:col-span-2">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Upcoming Events</h2>
            </div>
            <div id="events" class="space-y-3">
                <!-- Events will be rendered here -->
            </div>
        </div>
        
        <!-- Tasks Widget -->
        <div class="bg-[#1a1a1a] border border-[#2a2a2a] rounded-lg p-6 min-h-[200px]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Tasks</h2>
                <button onclick="app.addTask()" class="text-primary hover:text-primary/80 text-2xl">+</button>
            </div>
            <div id="tasks" class="space-y-3">
                <!-- Tasks will be rendered here -->
            </div>
        </div>
        
        <!-- Notes Widget -->
        <div class="bg-[#1a1a1a] border border-[#2a2a2a] rounded-lg p-6 min-h-[200px]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Notes</h2>
                <button onclick="app.addNote()" class="text-primary hover:text-primary/80 text-2xl">+</button>
            </div>
            <div id="notes" class="space-y-3">
                <!-- Notes will be rendered here -->
            </div>
        </div>
        
    </div>

    <!-- Modal for adding/editing -->
    <div id="modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
        <div class="bg-[#1a1a1a] border border-[#2a2a2a] rounded-lg p-6 max-w-md w-full">
            <h3 id="modalTitle" class="text-xl font-semibold mb-4">Add Item</h3>
            <div id="modalContent"></div>
            <div class="flex gap-3 mt-4">
                <button onclick="app.closeModal()" class="flex-1 bg-[#2a2a2a] hover:bg-[#3a3a3a] rounded px-4 py-2">Cancel</button>
                <button id="modalSubmit" class="flex-1 bg-primary hover:bg-primary/80 rounded px-4 py-2">Save</button>
            </div>
        </div>
    </div>
    
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'personalos-v1';
                    self.addEventListener('install', (e) => {
                        e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(['/'])));
                    });
                    self.addEventListener('fetch', (e) => {
                        e.respondWith(
                            caches.match(e.request).then(response => response || fetch(e.request))
                        );
                    });
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl);
            });
        }

        // IndexedDB Manager
        class DB {
            constructor() {
                this.db = null;
                this.dbName = 'PersonalOS';
                this.version = 1;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        
                        if (!db.objectStoreNames.contains('tasks')) {
                            db.createObjectStore('tasks', { keyPath: 'id', autoIncrement: true });
                        }
                        if (!db.objectStoreNames.contains('notes')) {
                            db.createObjectStore('notes', { keyPath: 'id', autoIncrement: true });
                        }
                        if (!db.objectStoreNames.contains('events')) {
                            db.createObjectStore('events', { keyPath: 'id', autoIncrement: true });
                        }
                    };
                });
            }

            async getAll(storeName) {
                const tx = this.db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async add(storeName, data) {
                const tx = this.db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.add(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async update(storeName, data) {
                const tx = this.db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.put(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async delete(storeName, id) {
                const tx = this.db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // Main App
        class App {
            constructor() {
                this.db = new DB();
                this.currentDate = new Date();
                this.init();
            }

            async init() {
                await this.db.init();
                this.updateTime();
                await this.renderCalendar();
                await this.renderTasks();
                await this.renderNotes();
                await this.renderEvents();
                
                setInterval(() => this.updateTime(), 1000);
            }

            updateTime() {
                const now = new Date();
                const timeEl = document.getElementById('time');
                const dateEl = document.getElementById('date');
                
                timeEl.textContent = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
                
                dateEl.textContent = now.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }

            async renderCalendar() {
                try {
                    const cal = document.getElementById('calendar');
                    if (!cal) return;
                    
                    const year = this.currentDate.getFullYear();
                    const month = this.currentDate.getMonth();
                    const today = new Date();
                    
                    const firstDay = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const daysInPrevMonth = new Date(year, month, 0).getDate();
                    
                    // Get all events for the month
                    let events = [];
                    try {
                        events = await this.db.getAll('events') || [];
                    } catch (e) {
                        console.error('Error loading events:', e);
                    }
                    
                    const eventDays = new Set();
                    
                    events.forEach(event => {
                        try {
                            const occurrences = this.getEventOccurrences(event, year, month);
                            occurrences.forEach(date => eventDays.add(date.getDate()));
                        } catch (e) {
                            console.error('Error processing event:', e);
                        }
                    });
                    
                    let html = '';
                    
                    // Day headers
                    ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
                        html += `<div class="text-gray-500">${day}</div>`;
                    });
                    
                    // Previous month days
                    for (let i = firstDay - 1; i >= 0; i--) {
                        html += `<div class="text-gray-600">${daysInPrevMonth - i}</div>`;
                    }
                    
                    // Current month days
                    for (let day = 1; day <= daysInMonth; day++) {
                        const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                        const hasEvent = eventDays.has(day);
                        const classes = isToday ? 'text-primary font-bold' : 'text-gray-400';
                        const indicator = hasEvent ? `<div class="w-1 h-1 bg-primary rounded-full mx-auto mt-1"></div>` : '';
                        html += `<div class="${classes}">${day}${indicator}</div>`;
                    }
                    
                    cal.innerHTML = html;
                    console.log('Calendar rendered with', html.length, 'characters');
                } catch (e) {
                    console.error('Error rendering calendar:', e);
                }
            }

            getEventOccurrences(event, year, month) {
                const occurrences = [];
                const eventDate = new Date(event.date);
                const startOfMonth = new Date(year, month, 1);
                const endOfMonth = new Date(year, month + 1, 0);
                
                if (event.repeat === 'none') {
                    if (eventDate >= startOfMonth && eventDate <= endOfMonth) {
                        occurrences.push(eventDate);
                    }
                } else if (event.repeat === 'daily') {
                    let current = new Date(Math.max(eventDate, startOfMonth));
                    while (current <= endOfMonth) {
                        if (current >= eventDate) {
                            occurrences.push(new Date(current));
                        }
                        current.setDate(current.getDate() + 1);
                    }
                } else if (event.repeat === 'weekly') {
                    let current = new Date(eventDate);
                    while (current <= endOfMonth) {
                        if (current >= startOfMonth && current >= eventDate) {
                            occurrences.push(new Date(current));
                        }
                        current.setDate(current.getDate() + 7);
                    }
                } else if (event.repeat === 'monthly') {
                    const eventDay = eventDate.getDate();
                    if (year > eventDate.getFullYear() || (year === eventDate.getFullYear() && month >= eventDate.getMonth())) {
                        const daysInThisMonth = new Date(year, month + 1, 0).getDate();
                        if (eventDay <= daysInThisMonth) {
                            occurrences.push(new Date(year, month, eventDay));
                        }
                    }
                }
                
                return occurrences;
            }

            async goToToday() {
                this.currentDate = new Date();
                await this.renderCalendar();
            }

            async renderTasks() {
                const tasks = await this.db.getAll('tasks');
                const container = document.getElementById('tasks');
                
                if (tasks.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-sm">No tasks yet</div>';
                    return;
                }
                
                container.innerHTML = tasks.map(task => `
                    <div class="flex items-center gap-3 group">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} 
                               onchange="app.toggleTask(${task.id})"
                               class="w-4 h-4 accent-primary cursor-pointer">
                        <span class="text-gray-300 flex-1 ${task.completed ? 'line-through opacity-50' : ''}">${task.text}</span>
                        <button onclick="app.deleteTask(${task.id})" 
                                class="text-red-500 opacity-0 group-hover:opacity-100 text-sm">×</button>
                    </div>
                `).join('');
            }

            async toggleTask(id) {
                const tasks = await this.db.getAll('tasks');
                const task = tasks.find(t => t.id === id);
                if (task) {
                    task.completed = !task.completed;
                    await this.db.update('tasks', task);
                    await this.renderTasks();
                }
            }

            async deleteTask(id) {
                await this.db.delete('tasks', id);
                await this.renderTasks();
            }

            addTask() {
                const modal = document.getElementById('modal');
                const title = document.getElementById('modalTitle');
                const content = document.getElementById('modalContent');
                const submit = document.getElementById('modalSubmit');
                
                title.textContent = 'Add Task';
                content.innerHTML = '<input id="taskInput" type="text" placeholder="Task description" class="w-full bg-[#0a0a0a] border border-[#2a2a2a] rounded px-3 py-2 text-white">';
                
                modal.classList.remove('hidden');
                setTimeout(() => document.getElementById('taskInput').focus(), 100);
                
                submit.onclick = async () => {
                    const input = document.getElementById('taskInput').value.trim();
                    if (input) {
                        await this.db.add('tasks', { text: input, completed: false });
                        await this.renderTasks();
                        this.closeModal();
                    }
                };
            }

            async renderNotes() {
                const notes = await this.db.getAll('notes');
                const container = document.getElementById('notes');
                
                if (notes.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-sm">No notes yet</div>';
                    return;
                }
                
                container.innerHTML = notes.map(note => `
                    <div class="bg-[#0a0a0a] border border-[#2a2a2a] rounded p-3 group relative">
                        <button onclick="app.deleteNote(${note.id})" 
                                class="absolute top-2 right-2 text-red-500 opacity-0 group-hover:opacity-100 text-sm">×</button>
                        <div class="font-medium text-sm mb-1">${note.title}</div>
                        <div class="text-gray-400 text-xs">${note.content.substring(0, 100)}${note.content.length > 100 ? '...' : ''}</div>
                    </div>
                `).join('');
            }

            async deleteNote(id) {
                await this.db.delete('notes', id);
                await this.renderNotes();
            }

            async renderEvents() {
                const events = await this.db.getAll('events');
                const container = document.getElementById('events');
                
                console.log('Rendering events, total count:', events.length);
                
                if (events.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-sm">No events yet</div>';
                    return;
                }
                
                // Get current timestamp (start of today)
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                const nowTS = now.getTime();
                
                const upcoming = [];
                
                events.forEach(event => {
                    // Parse date string as YYYY-MM-DD and create date at noon to avoid timezone issues
                    const dateStr = event.date + 'T12:00:00'; // Add time to force local timezone
                    const eventDate = new Date(dateStr);
                    eventDate.setHours(0, 0, 0, 0);
                    const eventTS = eventDate.getTime();
                    
                    console.log('Event:', event.title, 'date:', event.date, 'eventTS:', eventTS, 'nowTS:', nowTS, 'show:', eventTS >= nowTS);
                    
                    if (eventTS >= nowTS) {
                        upcoming.push({ ...event, nextDate: eventDate });
                    }
                });
                
                console.log('Upcoming events:', upcoming);
                
                if (upcoming.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-sm">No upcoming events</div>';
                    return;
                }
                
                // Sort by date
                upcoming.sort((a, b) => a.nextDate - b.nextDate);
                
                // Show all events
                container.innerHTML = upcoming.map(event => {
                    const dateStr = event.nextDate.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric',
                        year: event.nextDate.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
                    });
                    const timeStr = event.time || 'All day';
                    const repeatBadge = event.repeat !== 'none' ? `<span class="text-xs bg-primary/20 text-primary px-2 py-0.5 rounded">${event.repeat}</span>` : '';
                    
                    return `
                        <div class="bg-[#0a0a0a] border border-[#2a2a2a] rounded p-3 group relative flex items-start gap-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="font-medium text-sm">${event.title}</div>
                                    ${repeatBadge}
                                </div>
                                <div class="text-gray-400 text-xs">${dateStr} • ${timeStr}</div>
                                ${event.description ? `<div class="text-gray-500 text-xs mt-1">${event.description}</div>` : ''}
                            </div>
                            <button onclick="app.deleteEvent(${event.id})" 
                                    class="text-red-500 opacity-0 group-hover:opacity-100 text-sm">×</button>
                        </div>
                    `;
                }).join('');
            }

            getNextOccurrence(event, fromDate) {
                const eventDate = new Date(event.date);
                if (eventDate > fromDate && event.repeat === 'none') {
                    return eventDate;
                }
                
                let current = new Date(fromDate);
                current.setHours(0, 0, 0, 0);
                
                if (event.repeat === 'daily') {
                    if (eventDate <= current) {
                        return current;
                    }
                    return eventDate;
                } else if (event.repeat === 'weekly') {
                    const dayOfWeek = eventDate.getDay();
                    const currentDayOfWeek = current.getDay();
                    const daysUntilNext = (dayOfWeek - currentDayOfWeek + 7) % 7;
                    current.setDate(current.getDate() + (daysUntilNext === 0 ? 7 : daysUntilNext));
                    
                    if (current < eventDate) {
                        return eventDate;
                    }
                    return current;
                } else if (event.repeat === 'monthly') {
                    const eventDay = eventDate.getDate();
                    current.setDate(eventDay);
                    
                    if (current < fromDate) {
                        current.setMonth(current.getMonth() + 1);
                    }
                    
                    if (current < eventDate) {
                        return eventDate;
                    }
                    return current;
                }
                
                return null;
            }

            async deleteEvent(id) {
                await this.db.delete('events', id);
                await this.renderEvents();
                await this.renderCalendar();
            }

            addEvent() {
                const modal = document.getElementById('modal');
                const title = document.getElementById('modalTitle');
                const content = document.getElementById('modalContent');
                const submit = document.getElementById('modalSubmit');
                
                title.textContent = 'Add Event';
                content.innerHTML = `
                    <input id="eventTitle" type="text" placeholder="Event title" class="w-full bg-[#0a0a0a] border border-[#2a2a2a] rounded px-3 py-2 text-white mb-3 box-border">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <input id="eventDate" type="date" class="w-full bg-[#0a0a0a] border border-[#2a2a2a] rounded px-3 py-2 text-white box-border min-w-0">
                        <input id="eventTime" type="time" class="w-full bg-[#0a0a0a] border border-[#2a2a2a] rounded px-3 py-2 text-white box-border min-w-0">
                    </div>
                    <select id="eventRepeat" class="w-full bg-[#0a0a0a] border border-[#2a2a2a] rounded px-3 py-2 text-white mb-3 box-border">
                        <option value="none">Does not repeat</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                    <textarea id="eventDescription" placeholder="Description (optional)" rows="3" class="w-full bg-[#0a0a0a] border border-[#2a2a2a] rounded px-3 py-2 text-white box-border resize-none"></textarea>
                `;
                
                modal.classList.remove('hidden');
                
                // Set default date to today and focus after DOM is ready
                setTimeout(() => {
                    const today = new Date().toISOString().split('T')[0];
                    const dateInput = document.getElementById('eventDate');
                    if (dateInput) {
                        dateInput.value = today;
                    }
                    document.getElementById('eventTitle')?.focus();
                }, 100);
                
                submit.onclick = async () => {
                    try {
                        const eventTitle = document.getElementById('eventTitle')?.value.trim();
                        const eventDate = document.getElementById('eventDate')?.value;
                        const eventTime = document.getElementById('eventTime')?.value;
                        const eventRepeat = document.getElementById('eventRepeat')?.value;
                        const eventDescription = document.getElementById('eventDescription')?.value.trim();
                        
                        console.log('Saving event:', { eventTitle, eventDate, eventTime, eventRepeat, eventDescription });
                        
                        if (eventTitle && eventDate) {
                            await this.db.add('events', { 
                                title: eventTitle, 
                                date: eventDate,
                                time: eventTime || '',
                                repeat: eventRepeat || 'none',
                                description: eventDescription || ''
                            });
                            await this.renderEvents();
                            await this.renderCalendar();
                            this.closeModal();
                            console.log('Event saved successfully');
                        } else {
                            console.error('Missing title or date');
                            alert('Please enter a title and date');
                        }
                    } catch (error) {
                        console.error('Error saving event:', error);
                        alert('Failed to save event: ' + error.message);
                    }
                };
            }

            addNote() {
                const modal = document.getElementById('modal');
                const title = document.getElementById('modalTitle');
                const content = document.getElementById('modalContent');
                const submit = document.getElementById('modalSubmit');
                
                title.textContent = 'Add Note';
                content.innerHTML = `
                    <input id="noteTitle" type="text" placeholder="Note title" class="w-full bg-[#0a0a0a] border border-[#2a2a2a] rounded px-3 py-2 text-white mb-3">
                    <textarea id="noteContent" placeholder="Note content" rows="4" class="w-full bg-[#0a0a0a] border border-[#2a2a2a] rounded px-3 py-2 text-white"></textarea>
                `;
                
                modal.classList.remove('hidden');
                setTimeout(() => document.getElementById('noteTitle').focus(), 100);
                
                submit.onclick = async () => {
                    const noteTitle = document.getElementById('noteTitle').value.trim();
                    const noteContent = document.getElementById('noteContent').value.trim();
                    if (noteTitle && noteContent) {
                        await this.db.add('notes', { title: noteTitle, content: noteContent });
                        await this.renderNotes();
                        this.closeModal();
                    }
                };
            }

            closeModal() {
                document.getElementById('modal').classList.add('hidden');
            }
        }

        // Initialize app
        const app = new App();
    </script>
    
</body>
</html>